<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Guru Berbagi - Selogiri</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
    body { background-color: #f8f9fa; font-family: 'Plus Jakarta Sans', sans-serif; color: #333; }
    
    .navbar { background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 1000; }
    .brand-text { line-height: 1.1; }
    .text-primary-custom { color: #0f766e; }

    /* CARD */
    .card-karya { border: none; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; height: 100%; display: flex; flex-direction: column; }
    .card-karya:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .card-thumb { height: 160px; background: #e9ecef; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .badge-type { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; font-size: 0.65rem; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
    .badge-status { position: absolute; top: 10px; right: 10px; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; }
    .bg-status-approved { background: #d1fae5; color: #065f46; }
    .bg-status-pending { background: #fef3c7; color: #92400e; }
    
    .card-body-custom { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
    .tag-row { margin-bottom: 8px; }
    .badge-soft { font-size: 0.65rem; padding: 4px 8px; border-radius: 6px; background: #f1f5f9; color: #475569; margin-right: 4px; font-weight: 600; }
    .karya-title { font-weight: 800; font-size: 1rem; margin-bottom: 5px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.8em; }
    .guru-name { font-size: 0.8rem; color: #64748b; margin-bottom: 15px; }

    .btn-action { width: 100%; background: #0f766e; color: white; border: none; padding: 8px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; }
    .btn-action:hover { background: #115e59; color: white; }
    .btn-icon-group { display: flex; gap: 5px; margin-top: 10px; }
    .btn-icon-small { flex: 1; border: 1px solid #e2e8f0; background: white; color: #64748b; padding: 6px; border-radius: 6px; font-size: 0.8rem; }
    .btn-icon-small:hover { background: #f8fafc; color: #0f172a; }

    /* UTILS */
    .d-none { display: none !important; }
    .admin-row { background: #fff7ed; border-left: 4px solid #f97316; }
    
    /* MODAL & PREVIEW */
    .modal-content { border: none; border-radius: 16px; }
    #previewFrame { width: 100%; height: 400px; border: none; background: #eee; border-radius: 8px; }
  </style>
</head>
<body>

  <nav class="navbar py-3">
    <div class="container">
      <div class="d-flex align-items-center gap-3">
        <img src="https://i.imgur.com/4PToETN.png" alt="Logo" height="40">
        <div class="brand-text">
          <div class="fw-bold text-primary-custom" style="font-size:1.1rem;">GURU BERBAGI</div>
          <div class="small text-muted" style="font-size:0.75rem;">KORWILCAMBIDIK SELOGIRI</div>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button id="btnHome" class="btn btn-sm btn-outline-secondary d-none" onclick="switchView('GALERI')">Kembali</button>
        <button id="btnAdmin" class="btn btn-sm btn-warning fw-bold d-none" onclick="switchView('ADMIN')">Admin</button>
        <button id="btnLogin" class="btn btn-sm btn-primary fw-bold px-4" onclick="loginModal()">Login</button>
        <div id="userPanel" class="d-none d-flex align-items-center gap-2">
           <span id="uName" class="fw-bold small">User</span>
           <button onclick="logout()" class="btn btn-sm btn-light border"><i class="fas fa-power-off text-danger"></i></button>
        </div>
      </div>
    </div>
  </nav>

  <div id="view-galeri" class="container mt-4 fade-in">
    <div class="row g-2 mb-4">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
          <input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Cari judul, mapel, atau guru..." oninput="doSearch()">
        </div>
      </div>
      <div class="col-md-3"><select id="filterMapel" class="form-select" onchange="doSearch()"><option value="">Semua Mapel</option></select></div>
      <div class="col-md-3"><select id="filterFase" class="form-select" onchange="doSearch()"><option value="">Semua Fase</option></select></div>
    </div>

    <div class="d-flex justify-content-between mb-4">
       <button id="btnAdd" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm d-none" onclick="resetForm(); modal('modalInput').show()"><i class="fas fa-plus me-2"></i>Bagikan Karya</button>
       <div>
         <button onclick="filterMode='ALL'; doSearch()" class="btn btn-sm btn-light border">Semua</button>
         <button onclick="filterMode='FAV'; doSearch()" class="btn btn-sm btn-light border text-danger"><i class="fas fa-heart"></i></button>
       </div>
    </div>

    <div id="loading" class="text-center py-5"><div class="spinner-border text-secondary"></div></div>
    <div id="galeri-container" class="row gx-3 gx-md-4 gy-4"></div>
  </div>

  <div id="view-admin" class="container mt-4 d-none">
    <div class="card border-0 shadow-sm p-4 mb-4">
      <h4 class="fw-bold">Dashboard Admin</h4>
      <p class="text-muted mb-0">Kelola data dan pengguna.</p>
    </div>

    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-karya">Kurasi Karya</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-user" onclick="loadUserList()">Manajemen Guru</button></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-karya">
         <input type="text" class="form-control mb-3" placeholder="Filter karya..." oninput="renderAdminTable(this.value)">
         <div class="table-responsive bg-white border rounded">
           <table class="table table-hover mb-0 align-middle">
             <thead class="bg-light"><tr><th class="ps-3">Judul & Mapel</th><th>Guru</th><th>Status</th><th class="text-end pe-3">Aksi</th></tr></thead>
             <tbody id="adminTableBody"></tbody>
           </table>
         </div>
      </div>
      <div class="tab-pane fade" id="tab-user">
         <button class="btn btn-primary btn-sm mb-3" onclick="resetUserForm(); modal('modalUser').show()">+ Tambah Guru</button>
         <div class="table-responsive bg-white border rounded">
           <table class="table table-hover mb-0 align-middle">
             <thead class="bg-light"><tr><th class="ps-3">Nama</th><th>Sekolah</th><th>PIN</th><th>Role</th><th class="text-end pe-3">Hapus</th></tr></thead>
             <tbody id="userTableBody"></tbody>
           </table>
         </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalInput" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="fw-bold">Input Karya</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <form id="formInput">
      <input type="hidden" id="formMode" value="ADD"><input type="hidden" id="editId">
      <div class="mb-3"><label class="small fw-bold">Judul</label><input type="text" id="inJudul" class="form-control" required></div>
      <div class="row g-2 mb-3">
         <div class="col-6"><label class="small fw-bold">Mapel</label><select id="inMapel" class="form-select"></select></div>
         <div class="col-6"><label class="small fw-bold">Jenis</label><select id="inJenis" class="form-select"></select></div>
      </div>
      <div class="row g-2 mb-3">
         <div class="col-6"><label class="small fw-bold">Fase</label><select id="inFase" class="form-select"></select></div>
         <div class="col-6"><label class="small fw-bold">Semester</label><select id="inSem" class="form-select"></select></div>
      </div>
      <div class="mb-3 p-2 bg-light rounded border"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkKaih" onchange="toggleKaih(this.checked)"><label class="form-check-label fw-bold small">Program KAIH?</label></div><select id="inKaih" class="form-select mt-2 d-none"></select></div>
      
      <div class="mb-2"><label class="small fw-bold">Link (YouTube/Drive/Gemini)</label><input type="url" id="inLink" class="form-control" placeholder="https://..."></div>
      <div class="mb-3"><label class="small fw-bold">Atau Kode Embed HTML</label><textarea id="inHtml" class="form-control font-monospace small" rows="3"></textarea></div>
    </form>
  </div><div class="modal-footer"><button onclick="saveData()" class="btn btn-primary w-100">SIMPAN DATA</button></div></div></div></div>

  <div class="modal fade" id="modalPreview" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content" style="height:90vh"><div class="modal-header py-2"><h6 class="fw-bold mb-0 text-truncate" id="prevTitle" style="max-width:80%;">Preview</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0 bg-dark d-flex align-items-center justify-content-center"><iframe id="framePreview" style="width:100%;height:100%;border:none;"></iframe></div></div></div></div>

  <div class="modal fade" id="modalUser" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="fw-bold">User</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="uNameInput" class="form-control mb-2" placeholder="Nama"><input id="uSchool" class="form-control mb-2" placeholder="Sekolah"><input id="uPin" class="form-control mb-2" placeholder="PIN (Angka)"><select id="uRoleInput" class="form-select"><option value="GURU">GURU</option><option value="ADMIN">ADMIN</option></select></div><div class="modal-footer"><button onclick="saveUser()" class="btn btn-primary w-100">SIMPAN USER</button></div></div></div></div>

  <div class="modal fade" id="modalKurasi" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="fw-bold">Kurasi</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="kurId"><select id="kurStatus" class="form-select mb-3"><option value="BARU">BARU</option><option value="DISETUJUI">DISETUJUI</option><option value="REVISI">REVISI</option></select><textarea id="kurFeed" class="form-control" rows="3" placeholder="Catatan..."></textarea></div><div class="modal-footer"><button onclick="saveKurasi()" class="btn btn-success w-100">UPDATE STATUS</button></div></div></div></div>

  <script>
    // --- KONFIGURASI API ---
    const API_URL = "https://script.google.com/macros/s/AKfycbzhrWjl2Dc0i8V45dD8vNXrt3gfmvEU1pZ5hZOELkTz6e29l68d2hsHfGQEjqTVYdY0/exec";

    // GLOBAL VARIABLES
    var DATA = [], USERS = [], SETTINGS = [];
    var USER = { name: 'Tamu', role: 'GUEST' };
    var filterMode = 'ALL'; 

    // --- MAIN INIT ---
    window.onload = () => {
       var saved = localStorage.getItem('GB_USER');
       if(saved) USER = JSON.parse(saved);
       updateUI();
       fetchData();
    };

    // --- DATA HANDLING ---
    async function api(act, pl=null) {
       try {
         var opt = { method: 'POST', body: JSON.stringify({ action: act, payload: pl }) };
         // Khusus Read pakai GET parameter biar cepat
         if(act==='read') { var r = await fetch(API_URL+"?action=read"); return await r.json(); }
         var r = await fetch(API_URL, opt); return await r.json();
       } catch(e) { return {status:'error', message:e.toString()}; }
    }

    function fetchData() {
       document.getElementById('loading').classList.remove('d-none');
       api('read').then(res => {
          if(res.status === 'success') {
             DATA = res.media; SETTINGS = res.settings;
             populateOptions();
             doSearch();
          }
          document.getElementById('loading').classList.add('d-none');
       });
    }

    // --- UI LOGIC ---
    function updateUI() {
       document.getElementById('uName').innerText = USER.name;
       var isGuest = USER.role === 'GUEST';
       document.getElementById('btnLogin').classList.toggle('d-none', !isGuest);
       document.getElementById('userPanel').classList.toggle('d-none', isGuest);
       document.getElementById('btnAdmin').classList.toggle('d-none', USER.role !== 'ADMIN');
       document.getElementById('btnAdd').classList.toggle('d-none', isGuest);
       
       if(USER.role === 'ADMIN' && !document.getElementById('view-admin').classList.contains('d-none')) {
          loadUserList();
       }
    }

    function switchView(v) {
       document.getElementById('view-galeri').classList.toggle('d-none', v !== 'GALERI');
       document.getElementById('view-admin').classList.toggle('d-none', v !== 'ADMIN');
       document.getElementById('heroSection').classList.toggle('d-none', v !== 'GALERI');
       document.getElementById('btnHome').classList.toggle('d-none', v === 'GALERI');
       
       if (v === 'ADMIN') { renderAdminTable(); loadUserList(); }
    }

    // --- GALERI LOGIC ---
    function doSearch() {
       var q = document.getElementById('searchInput').value.toLowerCase();
       var fM = document.getElementById('filterMapel').value;
       var fF = document.getElementById('filterFase').value;
       var favs = JSON.parse(localStorage.getItem('GB_FAV')||'[]');

       var res = DATA.filter(d => {
          var str = (d[1]+d[5]+d[6]).toLowerCase();
          var matchQ = str.includes(q);
          var matchM = fM ? d[6] === fM : true;
          var matchF = fF ? d[3] === fF : true;
          var matchMode = true;
          if(filterMode === 'MY') matchMode = d[1] === USER.name;
          if(filterMode === 'FAV') matchMode = favs.includes(d[13]);
          
          // Tampilkan hanya yang DISETUJUI, kecuali punya sendiri atau Admin
          var isPublic = d[9] === 'DISETUJUI' || d[1] === USER.name || USER.role === 'ADMIN';
          
          return matchQ && matchM && matchF && matchMode && isPublic;
       });
       
       renderCards(res);
    }

    function renderCards(list) {
       var c = document.getElementById('galeri-container'); c.innerHTML = '';
       var favs = JSON.parse(localStorage.getItem('GB_FAV')||'[]');

       list.forEach(item => {
          var idx = DATA.indexOf(item); // Real Index
          var isFav = favs.includes(item[13]);
          var heart = isFav ? 'fas text-danger' : 'far';
          
          // Thumbnail
          var thumb = getThumb(item);
          var badge = item[9] !== 'DISETUJUI' ? `<span class="badge-status bg-status-pending">PENDING</span>` : '';
          
          // Smart QR
          var link = item[8] || "";
          if(!link && item[7]) { var m = item[7].match(/src=["'](.*?)["']/); if(m) link = m[1]; }
          var btnQR = link.length > 5 ? `<button onclick="showQR('${link}')" class="btn-icon-small"><i class="fas fa-qrcode"></i></button>` : '';

          // Edit Delete
          var btnEdit = (USER.name === item[1] || USER.role === 'ADMIN') ? 
             `<button onclick="editItem(${idx})" class="btn-icon-small"><i class="fas fa-pencil"></i></button>
              <button onclick="delItem(${idx})" class="btn-icon-small text-danger"><i class="fas fa-trash"></i></button>` : '';

          var html = `
          <div class="col-6 col-md-4 col-lg-3 d-flex fade-in">
             <div class="card-karya w-100">
                <div class="card-thumb">
                   ${thumb} ${badge}
                   <span class="badge-type">${item[11] || 'MEDIA'}</span>
                   <button onclick="toggleFav('${item[13]}')" class="btn-wishlist"><i class="${heart} fa-heart"></i></button>
                </div>
                <div class="card-body-custom">
                   <div class="tag-row"><span class="badge-soft">${item[6]}</span><span class="badge-soft">${item[3]}</span></div>
                   <div class="karya-title" title="${item[5]}">${item[5]}</div>
                   <div class="guru-name"><i class="fas fa-user-circle me-1"></i>${item[1]}</div>
                   <div class="mt-auto">
                      <button onclick="openItem(${idx})" class="btn-action">BUKA KARYA</button>
                      <div class="btn-icon-group">${btnQR}${btnEdit}</div>
                   </div>
                </div>
             </div>
          </div>`;
          c.insertAdjacentHTML('beforeend', html);
       });
    }

    function getThumb(d) {
       var l = d[8] || "", t = d[11] || "";
       if(l.includes('youtu')) {
          var id = l.match(/v=([^&]+)/) || l.match(/youtu\.be\/([^?]+)/);
          if(id) return `<img src="https://img.youtube.com/vi/${id[1]}/mqdefault.jpg">`;
       }
       var color = '#64748b'; var icon = 'fa-file';
       if(t.includes('VIDEO')) { color='#ef4444'; icon='fa-play'; }
       else if(t.includes('GAME')) { color='#8b5cf6'; icon='fa-gamepad'; }
       else if(t.includes('MODUL')) { color='#10b981'; icon='fa-book'; }
       else if(t.includes('GEMINI')) { color='#f59e0b'; icon='fa-robot'; }
       return `<div style="background:${color};width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:white"><i class="fas ${icon} fa-3x"></i></div>`;
    }

    // --- ACTIONS ---
    function openItem(idx) {
       var d = DATA[idx];
       var link = d[8];
       
       // Tambah View
       api('view', {id: d[13]});

       // Logic Gemini -> New Tab
       if(link && (link.includes('gemini') || link.includes('story'))) {
          if(link.includes('/share')) link = link.replace('gemini.google.com','g.co/gemini');
          window.open(link, '_blank');
          return;
       }

       // Normal Preview -> Modal
       var frame = document.getElementById('framePreview');
       document.getElementById('prevTitle').innerText = d[5];
       
       if (d[7] && d[7].length > 10) {
          // HTML Blob
          frame.src = URL.createObjectURL(new Blob([d[7]], {type: 'text/html'}));
       } else if (link) {
          if(link.includes('youtu')) {
             var id = link.match(/v=([^&]+)/) || link.match(/youtu\.be\/([^?]+)/);
             frame.src = `https://www.youtube.com/embed/${id[1]}?autoplay=1`;
          } else if (link.includes('drive.google')) {
             frame.src = link.replace('/view', '/preview');
          } else {
             frame.src = link;
          }
       }
       modal('modalPreview').show();
    }

    function showQR(link) {
       Swal.fire({
          html: `<img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(link)}" class="img-fluid mb-2"><br><a href="${link}" target="_blank" class="btn btn-sm btn-dark">Buka Link</a>`,
          showConfirmButton: false, showCloseButton: true
       });
    }

    function toggleFav(id) {
       var k = 'GB_FAV', cur = JSON.parse(localStorage.getItem(k)||'[]');
       if(cur.includes(id)) cur = cur.filter(x => x!==id); else cur.push(id);
       localStorage.setItem(k, JSON.stringify(cur));
       doSearch(); // Refresh UI
    }

    // --- CRUD ---
    function saveData() {
       var p = {
          mode: document.getElementById('formMode').value,
          idUnik: document.getElementById('editId').value,
          nama: USER.name, sekolah: USER.school,
          judul: document.getElementById('inJudul').value,
          mapel: document.getElementById('inMapel').value,
          jenis: document.getElementById('inJenis').value,
          fase: document.getElementById('inFase').value,
          semester: document.getElementById('inSem').value,
          linkLuar: document.getElementById('inLink').value,
          kodeHtml: document.getElementById('inHtml').value,
          kaihType: document.getElementById('checkKaih').checked ? document.getElementById('inKaih').value : ''
       };
       
       // Convert Gemini Link on Save
       if(p.linkLuar.includes('gemini.google.com/share')) {
          p.linkLuar = p.linkLuar.replace('gemini.google.com/share', 'g.co/gemini/share');
       }

       Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()});
       api('simpan', p).then(res => {
          modal('modalInput').hide();
          Swal.fire('Berhasil', '', 'success');
          fetchData();
       });
    }

    function delItem(idx) {
       Swal.fire({title:'Hapus?', icon:'warning', showCancelButton:true}).then(r => {
          if(r.isConfirmed) {
             api('hapus', {id: DATA[idx][13]}).then(() => fetchData());
          }
       });
    }

    // --- ADMIN ---
    function renderAdminTable(q='') {
       var t = document.getElementById('adminTableBody'); t.innerHTML = '';
       var filtered = DATA.filter(d => (d[1]+d[5]).toLowerCase().includes(q.toLowerCase()));
       
       filtered.forEach(d => {
          var idx = DATA.indexOf(d);
          var badge = d[9] === 'DISETUJUI' ? 'bg-success' : (d[9]==='REVISI'?'bg-danger':'bg-warning');
          t.innerHTML += `<tr>
             <td class="ps-3"><div class="fw-bold">${d[5]}</div><div class="small text-muted">${d[6]}</div></td>
             <td><div class="fw-bold small">${d[1]}</div><div class="small text-muted">${d[2]}</div></td>
             <td><span class="badge ${badge}">${d[9]}</span></td>
             <td class="text-end pe-3">
                <button onclick="kurasi(${idx})" class="btn btn-sm btn-outline-primary"><i class="fas fa-check"></i></button>
                <button onclick="delItem(${idx})" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
             </td>
          </tr>`;
       });
    }

    function kurasi(idx) {
       var d = DATA[idx];
       document.getElementById('kurId').value = d[13];
       document.getElementById('kurStatus').value = d[9];
       document.getElementById('kurFeed').value = d[12] || '';
       modal('modalKurasi').show();
    }
    
    function saveKurasi() {
       api('updateKurasi', {
          id: document.getElementById('kurId').value,
          status: document.getElementById('kurStatus').value,
          feedback: document.getElementById('kurFeed').value
       }).then(() => { modal('modalKurasi').hide(); fetchData(); });
    }

    // --- USER MANAGEMENT ---
    function loadUserList() {
       api('users').then(res => {
          USERS = res.data;
          var t = document.getElementById('userTableBody'); t.innerHTML = '';
          USERS.forEach(u => {
             t.innerHTML += `<tr><td class="ps-3 fw-bold">${u[0]}</td><td>${u[1]}</td><td>${u[2]}</td><td>${u[3]}</td><td class="text-end pe-3"><button onclick="delUser('${u[2]}')" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button></td></tr>`;
          });
       });
    }
    function saveUser() {
       var p = { nama: document.getElementById('uNameInput').value, sekolah: document.getElementById('uSchool').value, pin: document.getElementById('uPin').value, role: document.getElementById('uRoleInput').value };
       api('simpanUser', p).then(res => {
          if(res.status==='success') { modal('modalUser').hide(); loadUserList(); Swal.fire('Sukses'); }
          else Swal.fire('Error', res.message, 'error');
       });
    }
    function delUser(pin) {
       if(confirm('Hapus user?')) api('hapusUser', {pin: pin}).then(() => loadUserList());
    }

    // --- AUTH ---
    function loginModal() {
       Swal.fire({title:'Masukkan PIN', input:'password'}).then(r => {
          if(r.value) api('login', {pin: r.value}).then(res => {
             if(res.status === 'success') {
                localStorage.setItem('GB_USER', JSON.stringify(res.user));
                USER = res.user; updateUI(); Swal.fire('Login Berhasil', '', 'success');
             } else Swal.fire('Gagal', res.message, 'error');
          });
       });
    }
    function logout() { localStorage.removeItem('GB_USER'); location.reload(); }

    // --- HELPERS ---
    function modal(id) { return new bootstrap.Modal(document.getElementById(id)); }
    function populateOptions() {
       var fill = (id, idx) => {
          var el = document.getElementById(id); el.innerHTML = '<option value="">Pilih...</option>';
          var opts = [...new Set(SETTINGS.map(s => s[idx]).filter(Boolean))];
          opts.forEach(o => el.innerHTML += `<option value="${o}">${o}</option>`);
       };
       fill('inMapel', 1); fill('inJenis', 0); fill('inFase', 2); fill('inKaih', 3); fill('inSem', 4);
       
       // Isi Filter Depan juga
       var fillFilter = (id, idx, def) => {
          var el = document.getElementById(id); el.innerHTML = `<option value="">${def}</option>`;
          var opts = [...new Set(SETTINGS.map(s => s[idx]).filter(Boolean))];
          opts.forEach(o => el.innerHTML += `<option value="${o}">${o}</option>`);
       };
       fillFilter('filterMapel', 1, 'ðŸ“š Semua Mapel');
       fillFilter('filterFase', 2, 'ðŸŽ“ Semua Fase');
       fillFilter('filterJenis', 0, 'ðŸ“‚ Semua Jenis');
    }
    function toggleKaih(c) { document.getElementById('inKaih').classList.toggle('d-none', !c); }
    function resetForm() { document.getElementById('formInput').reset(); document.getElementById('formMode').value='ADD'; }
    function editItem(idx) {
       var d = DATA[idx];
       document.getElementById('formMode').value = 'EDIT';
       document.getElementById('editId').value = d[13];
       document.getElementById('inJudul').value = d[5];
       document.getElementById('inHtml').value = d[7];
       document.getElementById('inLink').value = d[8];
       // Set dropdowns value (simplified for brevity)
       modal('modalInput').show();
    }
    function toggleInputSource(val) {
       document.getElementById('groupLink').classList.toggle('d-none', val !== 'LINK');
       document.getElementById('groupHtml').classList.toggle('d-none', val !== 'HTML');
    }
  </script>
</body>
</html>
