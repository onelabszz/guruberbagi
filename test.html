<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Guru Berbagi - Selogiri</title>
  
  <!-- CSS Framework: Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Icons: FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root { 
      --primary: #2D8B83; 
      --primary-dark: #1F6660;
      --bg-body: #f8fafc; 
      --text-main: #1e293b;
      --text-muted: #64748b;
      --card-radius: 16px;
      --transition-speed: 0.4s;
    }

    body { background-color: var(--bg-body); font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text-main); font-size: 0.95rem; padding-bottom: 100px; overflow-x: hidden; }

    /* --- ANIMATIONS & TRANSITIONS --- */
    .view-container {
      position: relative;
      min-height: 80vh;
    }
    
    .view-section {
      transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease;
      opacity: 0;
      transform: translateY(20px);
      position: absolute;
      top: 0; left: 0; width: 100%;
      pointer-events: none;
      z-index: 0;
    }
    
    .view-section.active {
      opacity: 1;
      transform: translateY(0);
      position: relative;
      pointer-events: auto;
      z-index: 1;
    }

    /* --- NAVBAR --- */
    .navbar { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1030; }
    .brand-title { font-weight: 800; color: var(--primary); font-size: 1.25rem; letter-spacing: -0.5px; line-height: 1.1; }
    .brand-subtitle { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); }

    /* --- CONTROLS --- */
    .filter-bar { background: #fff; padding: 1rem; border-radius: var(--card-radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); border: 1px solid #f1f5f9; margin-bottom: 1.5rem; }
    .btn-view-mode { border: 1px solid #e2e8f0; background: #fff; color: #64748b; padding: 6px 10px; transition: 0.2s; }
    .btn-view-mode:hover { background: #f1f5f9; color: var(--primary); }
    .btn-view-mode.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* --- CARD SYSTEM --- */
    .card-karya { 
      background: #fff; border: 1px solid #f1f5f9; border-radius: var(--card-radius); 
      overflow: hidden; height: 100%; display: flex; flex-direction: column; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: transform 0.2s, box-shadow 0.2s;
    }
    .card-karya:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }

    /* LIST VIEW MODE STYLES */
    .list-view .card-karya { flex-direction: row; min-height: 160px; }
    .list-view .card-thumb { width: 220px; height: auto; flex-shrink: 0; }
    .list-view .card-body-mp { padding: 16px; justify-content: center; }
    @media(max-width: 576px) { .list-view .card-thumb { width: 120px; } .list-view .mp-tags { display: none; } }

    .card-thumb { position: relative; background: #e2e8f0; aspect-ratio: 16/9; overflow: hidden; }
    .list-view .card-thumb { aspect-ratio: auto; }
    
    .view-badge { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 6px; font-weight: 700; z-index: 2; backdrop-filter: blur(2px); }
    .badge-status { position: absolute; top: 8px; left: 8px; font-size: 0.65rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    .card-body-mp { padding: 14px; flex-grow: 1; display: flex; flex-direction: column; }
    .mp-title { font-weight: 800; font-size: 1rem; line-height: 1.3; color: var(--text-main); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .guru-info { display: flex; align-items: center; gap: 8px; margin-top: auto; padding-top: 10px; border-top: 1px dashed #e2e8f0; }
    .guru-avatar { width: 28px; height: 28px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; color: #64748b; }

    /* --- FEEDBACK BOX --- */
    .feedback-box { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; margin-top: 8px; position: relative; }
    .feedback-box::before { content: ''; position: absolute; top: -6px; left: 20px; width: 10px; height: 10px; background: #fffbeb; border-top: 1px solid #fcd34d; border-left: 1px solid #fcd34d; transform: rotate(45deg); }

    /* --- DASHBOARD STATS --- */
    .stat-card { background: #fff; padding: 1.5rem; border-radius: 16px; border: 1px solid #e2e8f0; position: relative; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .stat-val { font-size: 2rem; font-weight: 800; line-height: 1; color: var(--primary); }
    .stat-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; }

    /* --- FAB --- */
    .fab-add { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 20px; background: var(--text-main); color: white; border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 1020; font-size: 1.5rem; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
    .fab-add:hover { transform: scale(1.1) rotate(90deg); background: var(--primary); }

    /* --- PREVIEW OVERLAY --- */
    #previewOverlay { position: fixed; inset: 0; background: #000; z-index: 20000; display: none; flex-direction: column; }
    .preview-header { padding: 10px 15px; background: #111; color: white; display: flex; justify-content: space-between; align-items: center; }
    #previewFrame { flex: 1; border: none; background: #fff; }

    .d-none { display: none !important; }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "sweetalert2": "https://esm.sh/sweetalert2@^11.26.17"
  }
}
</script>
</head>
<body>

  <!-- PREVIEW OVERLAY -->
  <div id="previewOverlay">
    <div class="preview-header">
      <div class="text-truncate fw-bold pe-3" id="previewTitle" style="max-width: 60%;">Preview</div>
      <button onclick="tutupPreview()" class="btn btn-sm btn-danger rounded-pill px-3 fw-bold"><i class="fas fa-times"></i> Tutup</button>
    </div>
    <iframe id="previewFrame" allowfullscreen allow="autoplay; encrypted-media"></iframe>
  </div>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="container d-flex justify-content-between align-items-center py-2">
      <div class="d-flex align-items-center gap-2">
        <img src="https://i.imgur.com/kNgOisY.png" alt="Logo" style="height: 42px;">
        <div class="d-flex flex-column">
          <span class="brand-title">GURU BERBAGI</span>
          <span class="brand-subtitle">Korwilcambidik Selogiri</span>
        </div>
      </div>
      
      <div class="d-flex align-items-center gap-2">
        <button id="btnSwitchView" onclick="toggleMainView()" class="btn btn-sm btn-warning rounded-pill fw-bold shadow-sm d-none">
          <i class="fas fa-exchange-alt me-1"></i> <span id="btnSwitchText">Admin</span>
        </button>
        <div id="userProfile" class="d-none d-flex align-items-center gap-2" onclick="logout()" style="cursor: pointer;">
          <div class="text-end d-none d-sm-block lh-1">
            <div id="uName" class="fw-bold text-dark" style="font-size:0.8rem;">User</div>
            <div id="uRole" class="badge bg-secondary" style="font-size:0.6rem;">GURU</div>
          </div>
          <button class="btn btn-sm btn-light rounded-circle border text-danger shadow-sm" style="width:32px;height:32px;"><i class="fas fa-power-off"></i></button>
        </div>
        <button id="btnLogin" onclick="loginModal()" class="btn btn-sm btn-primary rounded-pill fw-bold px-3">Login</button>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTAINER WITH TRANSITIONS -->
  <div class="container mt-4 px-3 px-md-4 view-container">
    
    <!-- SECTION: GALERI -->
    <div id="view-galeri" class="view-section active">
      
      <!-- Filter & View Controls -->
      <div class="filter-bar">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-md-5">
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
              <input type="text" id="searchInput" oninput="handleSearch(this.value)" class="form-control bg-light border-start-0 fw-bold" placeholder="Cari karya, guru...">
            </div>
          </div>
          
          <div class="col-6 col-md-3">
            <select id="filterMapel" class="form-select bg-light fw-bold text-secondary" style="font-size:0.85rem;" onchange="applyFilters()">
              <option value="">Semua Mapel</option>
            </select>
          </div>
          
          <div class="col-6 col-md-4 d-flex justify-content-end align-items-center gap-2">
            <!-- View Mode Switcher -->
            <div class="btn-group shadow-sm rounded-3 overflow-hidden" role="group">
              <button type="button" class="btn btn-view-mode" onclick="setViewMode('GRID_LG')" title="Grid Besar"><i class="fas fa-square"></i></button>
              <button type="button" class="btn btn-view-mode active" onclick="setViewMode('GRID_MD')" title="Grid Sedang"><i class="fas fa-th-large"></i></button>
              <button type="button" class="btn btn-view-mode" onclick="setViewMode('LIST')" title="List"><i class="fas fa-list"></i></button>
            </div>
            
            <button onclick="toggleMyWorks()" id="btnMyWorks" class="btn btn-outline-primary btn-sm rounded-pill fw-bold px-3 d-none">Saya</button>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div id="loader" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 small fw-bold text-muted">Memuat data...</div></div>
      
      <!-- Gallery Grid -->
      <div id="galeri-container" class="row g-3"></div>
      
      <div id="loadMoreContainer" class="text-center mt-5 mb-5 d-none">
         <button onclick="loadMoreItems()" class="btn btn-outline-dark rounded-pill px-5 fw-bold shadow-sm">Muat Lebih Banyak</button>
      </div>
    </div>

    <!-- SECTION: ADMIN DASHBOARD -->
    <div id="view-admin" class="view-section">
      <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded-4 shadow-sm border">
        <div><h4 class="fw-800 mb-0">Dashboard Admin</h4><small class="text-muted">Manajemen konten & pengguna</small></div>
        <span class="badge bg-primary rounded-pill px-3">ADMIN</span>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="stat-card"> <div class="stat-val" id="statTotal">0</div> <div class="stat-label">Total Karya</div> </div></div>
        <div class="col-6 col-md-3"><div class="stat-card"> <div class="stat-val text-success" id="statApproved">0</div> <div class="stat-label">Disetujui</div> </div></div>
        <div class="col-6 col-md-3"><div class="stat-card"> <div class="stat-val text-warning" id="statPending">0</div> <div class="stat-label">Perlu Kurasi</div> </div></div>
        <div class="col-6 col-md-3"><div class="stat-card"> <div class="stat-val text-secondary" id="statUsers">0</div> <div class="stat-label">Guru</div> </div></div>
      </div>

      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-bottom p-0">
          <ul class="nav nav-tabs nav-fill card-header-tabs m-0 border-0">
            <li class="nav-item"><button class="nav-link active py-3 fw-bold border-0 border-bottom border-3 border-primary" data-bs-toggle="tab" data-bs-target="#tab-media">Kurasi Karya</button></li>
            <li class="nav-item"><button class="nav-link py-3 fw-bold border-0 text-muted" data-bs-toggle="tab" data-bs-target="#tab-users" onclick="loadUserList()">Data Guru</button></li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-media">
               <div class="p-3 bg-light border-bottom"><input type="text" class="form-control border-0 rounded-pill px-3" placeholder="Filter judul/guru..." oninput="searchAdmin(this.value)"></div>
               <div class="table-responsive"><table class="table table-hover align-middle mb-0 small"><tbody id="tableMedia"></tbody></table></div>
            </div>
            <div class="tab-pane fade" id="tab-users">
               <div class="p-3 d-flex justify-content-between bg-light border-bottom"><span class="fw-bold text-muted">DAFTAR GURU</span> <button class="btn btn-sm btn-primary rounded-pill fw-bold" onclick="showModalUser()"><i class="fas fa-plus"></i> Tambah</button></div>
               <div class="table-responsive"><table class="table table-hover align-middle mb-0 small"><tbody id="tableUsers"></tbody></table></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- FAB ADD -->
  <button id="btnAdd" class="fab-add d-none" onclick="resetForm(); showModalInput()"><i class="fas fa-plus"></i></button>

  <!-- MODAL INPUT -->
  <div class="modal fade" id="modalInput" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 rounded-4 shadow">
        <div class="modal-header border-bottom-0"><h5 class="fw-bold text-primary">Form Karya</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body bg-light">
          <form id="modalForm">
            <input type="hidden" id="formMode" value="ADD"><input type="hidden" id="editRowIdx">
            
            <div class="card border-0 shadow-sm p-3 mb-3">
               <label class="small fw-bold text-muted mb-1">Judul Karya <span class="text-danger">*</span></label>
               <input type="text" id="inJudul" class="form-control fw-bold" placeholder="Judul..." required>
            </div>

            <div class="row g-2 mb-3">
              <div class="col-6"><label class="small fw-bold text-muted">Mapel</label><select id="inMapel" class="form-select"></select></div>
              <div class="col-6"><label class="small fw-bold text-muted">Jenis</label><select id="inJenis" class="form-select"></select></div>
            </div>
            
            <div class="card border-0 shadow-sm p-3 mb-3">
               <label class="small fw-bold text-muted mb-2">Link / Konten</label>
               <div class="btn-group w-100 mb-2">
                  <input type="radio" class="btn-check" name="sType" id="stLink" value="LINK" checked onchange="toggleSrc('LINK')"><label class="btn btn-outline-secondary btn-sm" for="stLink">Link</label>
                  <input type="radio" class="btn-check" name="sType" id="stHtml" value="HTML" onchange="toggleSrc('HTML')"><label class="btn btn-outline-secondary btn-sm" for="stHtml">Embed</label>
               </div>
               <input type="url" id="inLink" class="form-control" placeholder="https://...">
               <textarea id="inHtml" class="form-control d-none font-monospace small" rows="3" placeholder="<iframe...>"></textarea>
            </div>
            
            <div class="form-check form-switch bg-white p-3 rounded shadow-sm">
               <input class="form-check-input" type="checkbox" id="checkKaih">
               <label class="form-check-label small fw-bold">Program KAIH?</label>
               <select id="inKaihType" class="form-select form-select-sm mt-2 d-none"></select>
            </div>

            <!-- MANUAL INPUTS HIDDEN -->
            <input type="hidden" id="manMapel"><input type="hidden" id="manJenis"><input type="hidden" id="inFase"><input type="hidden" id="inSem">
          </form>
        </div>
        <div class="modal-footer border-0">
          <button onclick="prosesSimpan()" class="btn btn-primary w-100 rounded-pill fw-bold shadow-sm">SIMPAN & AJUKAN</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL KURASI -->
  <div class="modal fade" id="modalKurasi" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4 shadow"><div class="modal-header border-0"><h5 class="fw-bold">Kurasi Karya</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="kurasiId"><div class="mb-3"><label class="small fw-bold">Status</label><select id="kurasiStatus" class="form-select"><option value="BARU">BARU (Pending)</option><option value="DISETUJUI">DISETUJUI</option><option value="REVISI">REVISI</option></select></div><textarea id="kurasiFeedback" class="form-control" rows="4" placeholder="Feedback untuk guru..."></textarea></div><div class="modal-footer border-0"><button onclick="simpanKurasi()" class="btn btn-primary w-100 rounded-pill fw-bold">Update Status</button></div></div></div></div>

  <!-- MODAL USER (Simplifikasi) -->
  <div class="modal fade" id="modalUser" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body"><h5 class="fw-bold mb-3">Data Guru</h5><form id="formUser"><input type="hidden" id="userMode" value="ADD"><input type="hidden" id="oldPin"><input type="text" id="userName" class="form-control mb-2" placeholder="Nama"><input type="text" id="userSchool" class="form-control mb-2" placeholder="Sekolah"><input type="text" id="userPin" class="form-control mb-2" placeholder="PIN"><select id="userRole" class="form-select mb-3"><option value="GURU">GURU</option><option value="ADMIN">ADMIN</option></select><button type="button" onclick="prosesSimpanUser()" class="btn btn-primary w-100 rounded-pill fw-bold">Simpan</button></form></div></div></div></div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzhrWjl2Dc0i8V45dD8vNXrt3gfmvEU1pZ5hZOELkTz6e29l68d2hsHfGQEjqTVYdY0/exec";
    const STATE = { 
        media: [], filtered: [], users: [], settings: [],
        user: { name: "Tamu", role: "GUEST" },
        viewMode: 'GRID_MD', // GRID_LG, GRID_MD, LIST
        limit: 12, step: 12,
        searchTimeout: null
    };

    window.onload = () => {
        const saved = localStorage.getItem('GB_USER');
        if(saved) STATE.user = JSON.parse(saved);
        updateUI();
        loadData();
    };

    async function api(action, payload=null) {
        try {
            if(action === 'read') {
                const c = JSON.parse(localStorage.getItem('GB_CACHE')||'{}');
                if(c.ts && Date.now() - c.ts < 300000) return c.data;
                const res = await fetch(API_URL + "?action=read");
                const json = await res.json();
                if(json.status === 'success') localStorage.setItem('GB_CACHE', JSON.stringify({ts: Date.now(), data: json}));
                return json;
            } else {
                localStorage.removeItem('GB_CACHE');
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, payload }) });
                return await res.json();
            }
        } catch(e) { console.error(e); return {status:'error'}; }
    }

    function loadData() {
        api('read').then(res => {
            if(res.status === 'success') {
                STATE.media = res.media; STATE.settings = res.settings;
                populateOpts(); applyFilters(); updateAdminStats();
            }
            document.getElementById('loader').classList.add('d-none');
        });
    }

    // --- VIEW LOGIC & TRANSITIONS ---
    function updateUI() {
        const isGuest = STATE.user.role === 'GUEST';
        const isAdmin = ['ADMIN','MODERATOR'].includes(STATE.user.role);
        
        document.getElementById('btnLogin').classList.toggle('d-none', !isGuest);
        document.getElementById('userProfile').classList.toggle('d-none', isGuest);
        document.getElementById('uName').innerText = STATE.user.name;
        document.getElementById('uRole').innerText = STATE.user.role;
        
        document.getElementById('btnSwitchView').classList.toggle('d-none', !isAdmin);
        document.getElementById('btnAdd').classList.toggle('d-none', isGuest);
        document.getElementById('btnMyWorks').classList.toggle('d-none', isGuest);

        // Update View Mode Buttons
        document.querySelectorAll('.btn-view-mode').forEach(b => b.classList.remove('active'));
        const modeIdx = STATE.viewMode === 'GRID_LG' ? 0 : (STATE.viewMode === 'LIST' ? 2 : 1);
        document.querySelectorAll('.btn-view-mode')[modeIdx].classList.add('active');
    }

    function toggleMainView() {
        const galeri = document.getElementById('view-galeri');
        const admin = document.getElementById('view-admin');
        const btnText = document.getElementById('btnSwitchText');
        
        if (galeri.classList.contains('active')) {
            // Go to Admin
            galeri.classList.remove('active');
            setTimeout(() => {
                admin.classList.add('active');
                btnText.innerText = 'Galeri';
                renderAdminTable();
            }, 400); // Wait for CSS transition
        } else {
            // Go to Gallery
            admin.classList.remove('active');
            setTimeout(() => {
                galeri.classList.add('active');
                btnText.innerText = 'Admin';
            }, 400);
        }
    }

    function setViewMode(mode) {
        STATE.viewMode = mode;
        updateUI();
        renderGaleri();
    }

    // --- FILTER & RENDER ---
    function handleSearch(val) { clearTimeout(STATE.searchTimeout); STATE.searchTimeout = setTimeout(() => applyFilters(), 400); }
    function toggleMyWorks() { 
        const btn = document.getElementById('btnMyWorks');
        btn.classList.toggle('active'); btn.classList.toggle('bg-primary'); btn.classList.toggle('text-white');
        applyFilters(); 
    }

    function applyFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const mapel = document.getElementById('filterMapel').value;
        const onlyMy = document.getElementById('btnMyWorks').classList.contains('active');
        
        STATE.filtered = STATE.media.filter(m => {
            // Guru bisa melihat karyanya sendiri walau status pending/revisi. Public hanya DISETUJUI.
            const isMine = m[1] === STATE.user.name;
            const isPublic = m[9] === 'DISETUJUI';
            if (!isMine && !isPublic && STATE.user.role !== 'ADMIN') return false;

            if (q && !(m[5]+m[1]).toLowerCase().includes(q)) return false;
            if (mapel && m[6] !== mapel) return false;
            if (onlyMy && !isMine) return false;
            return true;
        });
        
        STATE.limit = STATE.step;
        renderGaleri();
    }

    function renderGaleri() {
        const c = document.getElementById('galeri-container'); c.innerHTML = '';
        const data = STATE.filtered.slice(0, STATE.limit);
        
        // CSS Classes based on View Mode
        let colClass = 'col-6 col-md-4 col-lg-3';
        let containerClass = '';
        if (STATE.viewMode === 'GRID_LG') colClass = 'col-12 col-md-6';
        if (STATE.viewMode === 'LIST') { colClass = 'col-12 col-lg-6'; containerClass = 'list-view'; }
        
        c.className = `row g-3 ${containerClass}`; // Apply list-view class to container if needed

        if(data.length === 0) { c.innerHTML = `<div class="col-12 text-center py-5 text-muted opacity-50">Tidak ada karya ditemukan.</div>`; return; }

        data.forEach(item => {
            const idx = STATE.media.indexOf(item);
            const [ts, auth, sch, fase, sem, title, mapel, html, link, status, kaih, type, fb, id, views] = item;
            
            const isOwner = auth === STATE.user.name;
            const isAdmin = STATE.user.role === 'ADMIN';
            
            // LOGIC: STATUS BADGE (Only for Owner/Admin if not Approved)
            let statusBadge = '';
            if ((isOwner || isAdmin) && status !== 'DISETUJUI') {
               const color = status === 'REVISI' ? 'bg-danger' : 'bg-warning text-dark';
               statusBadge = `<div class="badge-status ${color}">${status}</div>`;
            }
            
            // LOGIC: FEEDBACK (Only for Owner)
            let feedbackHtml = '';
            if ((isOwner || isAdmin) && fb && fb.length > 2) {
                feedbackHtml = `<div class="feedback-box"><i class="fas fa-comment-dots me-1"></i> <b>Moderator:</b> ${clean(fb)}</div>`;
            }

            // LOGIC: RESUBMIT BUTTON (Only for Owner & Status REVISI)
            let resubmitBtn = '';
            if (isOwner && status === 'REVISI') {
                resubmitBtn = `<button onclick="submitReview('${id}')" class="btn btn-sm btn-outline-danger w-100 mt-2 fw-bold" style="font-size:0.75rem"><i class="fas fa-paper-plane me-1"></i> Ajukan Ulang</button>`;
            }

            let thumb = getThumb(type, link);
            let tools = (isOwner||isAdmin) ? `<button onclick="editItem(${idx})" class="btn btn-sm btn-light border"><i class="fas fa-pencil-alt text-primary"></i></button><button onclick="delItem('${id}')" class="btn btn-sm btn-light border"><i class="fas fa-trash text-danger"></i></button>` : '';

            const htmlStr = `
            <div class="${colClass}">
              <div class="card-karya">
                <div class="card-thumb">
                   ${thumb} ${statusBadge}
                   <div class="view-badge"><i class="fas fa-eye"></i> ${views||0}</div>
                </div>
                <div class="card-body-mp">
                   <div class="mp-tags mb-1"><span class="badge bg-light text-dark border">${mapel}</span></div>
                   <div class="mp-title" title="${clean(title)}">${clean(title)}</div>
                   
                   ${feedbackHtml}
                   ${resubmitBtn}

                   <div class="guru-info">
                      <div class="guru-avatar">${auth.charAt(0)}</div>
                      <div style="line-height:1.2; overflow:hidden;">
                         <div class="fw-bold small text-truncate">${clean(auth)}</div>
                         <div class="text-muted" style="font-size:0.65rem">${clean(sch)}</div>
                      </div>
                   </div>
                   <div class="d-flex gap-2 mt-3">
                      <button onclick="preview(${idx})" class="btn btn-sm btn-primary flex-grow-1 fw-bold">Buka</button>
                      ${tools}
                   </div>
                </div>
              </div>
            </div>`;
            c.insertAdjacentHTML('beforeend', htmlStr);
        });

        if(STATE.filtered.length > STATE.limit) document.getElementById('loadMoreContainer').classList.remove('d-none');
        else document.getElementById('loadMoreContainer').classList.add('d-none');
    }

    // --- ACTIONS ---
    function submitReview(id) {
        Swal.fire({title:'Ajukan Ulang?', text:'Status akan berubah menjadi BARU (Pending).', icon:'question', showCancelButton:true}).then(r => {
            if(r.isConfirmed) {
                // We use updateKurasi but set status to BARU
                api('updateKurasi', {id: id, status: 'BARU', feedback: ''}).then(() => {
                    loadData(); Swal.fire('Terkirim', 'Karya menunggu moderasi.', 'success');
                });
            }
        });
    }

    function preview(idx) {
        const item = STATE.media[idx];
        api('view', {id: item[13]});
        const url = item[8], html = item[7];
        const overlay = document.getElementById('previewOverlay'), frame = document.getElementById('previewFrame');
        document.getElementById('previewTitle').innerText = item[5];
        
        if(url && (url.includes('gemini') || url.includes('g.co'))) { window.open(url, '_blank'); return; }
        
        let src = "";
        if(html && html.length > 10) src = URL.createObjectURL(new Blob([html], {type:'text/html'}));
        else if(url) {
            let yt = url.match(/(?:youtu\.be\/|v\/|embed\/|watch\?v=)([^#&?]*)/);
            src = yt ? `https://www.youtube.com/embed/${yt[1]}?autoplay=1` : (url.includes('drive') ? url.replace(/\/view.*/,'/preview') : url);
        }
        
        if(src) { overlay.style.display='flex'; frame.src = src; }
        else Swal.fire('Error','Konten tidak dapat dimuat','error');
    }
    function tutupPreview() { document.getElementById('previewOverlay').style.display='none'; document.getElementById('previewFrame').src=''; }

    function prosesSimpan() {
       const el = (id) => document.getElementById(id).value;
       const p = {
           id: el('editRowIdx'), user: STATE.user.name, school: STATE.user.school||"-",
           judul: el('inJudul'), mapel: el('inMapel'), jenis: el('inJenis'),
           link: el('inLink'), html: document.getElementById('stHtml').checked ? el('inHtml') : "",
           kaih: document.getElementById('checkKaih').checked ? el('inKaihType') : ""
       };
       
       if(!p.judul) return Swal.fire('Error','Judul wajib diisi','error');
       
       Swal.showLoading();
       api('add', p).then(res => {
           if(res.status==='success') {
               bootstrap.Modal.getInstance(document.getElementById('modalInput')).hide();
               loadData(); Swal.fire('Berhasil','Status karya: BARU (Pending)','success');
           } else Swal.fire('Gagal',res.message,'error');
       });
    }

    // --- HELPERS & ADMIN ---
    function clean(s) { return s ? s.toString().replace(/</g,"&lt;") : ""; }
    function getThumb(type, link) {
        let yt = link && link.match(/(?:youtu\.be\/|v\/|embed\/|watch\?v=)([^#&?]*)/);
        if(yt && yt[1].length===11) return `<img src="https://img.youtube.com/vi/${yt[1]}/mqdefault.jpg" style="width:100%;height:100%;object-fit:cover;">`;
        let icon='code', bg='#64748b', t=(type||"").toUpperCase();
        if(t.includes('VIDEO')){icon='play';bg='#ef4444'} else if(t.includes('MODUL')){icon='book-open';bg='#10b981'}
        return `<div style="width:100%;height:100%;background:${bg};display:flex;align-items:center;justify-content:center;color:white;flex-direction:column"><i class="fas fa-${icon} fa-2x mb-2"></i><span style="font-size:0.6rem;font-weight:800">${t}</span></div>`;
    }
    function populateOpts() {
        const s = STATE.settings;
        const fill = (id, idx) => { document.getElementById(id).innerHTML = '<option value="">Pilih</option>' + s.map(r=>r[idx]).filter(Boolean).map(v=>`<option value="${v}">${v}</option>`).join(''); }
        fill('filterMapel', 1); fill('inMapel', 1); fill('inJenis', 0); fill('inKaihType', 3);
    }
    
    // Admin functions
    function updateAdminStats() {
        document.getElementById('statTotal').innerText = STATE.media.length;
        document.getElementById('statApproved').innerText = STATE.media.filter(m=>m[9]==='DISETUJUI').length;
        document.getElementById('statPending').innerText = STATE.media.filter(m=>m[9]==='BARU').length;
    }
    function renderAdminTable() {
        document.getElementById('tableMedia').innerHTML = STATE.media.map(m => `<tr><td><div class="fw-bold">${clean(m[5])}</div><div class="text-muted">${clean(m[1])}</div></td><td><span class="badge ${m[9]==='DISETUJUI'?'bg-success':(m[9]==='REVISI'?'bg-danger':'bg-warning text-dark')}">${m[9]}</span></td><td class="text-end"><button onclick="bukaKurasi('${m[13]}','${m[9]}','${clean(m[12])}')" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button></td></tr>`).join('');
    }
    function searchAdmin(val) { const q=val.toLowerCase(); Array.from(document.querySelectorAll('#tableMedia tr')).forEach(r => r.style.display = r.innerText.toLowerCase().includes(q)?'':'none'); }

    // Modals
    function showModalInput() { new bootstrap.Modal('#modalInput').show(); }
    function resetForm() { document.getElementById('modalForm').reset(); document.getElementById('formMode').value='ADD'; toggleSrc('LINK'); document.getElementById('checkKaih').checked=false; document.getElementById('inKaihType').classList.add('d-none'); }
    function toggleSrc(t) { document.getElementById('inLink').classList.toggle('d-none', t!=='LINK'); document.getElementById('inHtml').classList.toggle('d-none', t!=='HTML'); }
    document.getElementById('checkKaih').onchange = (e) => document.getElementById('inKaihType').classList.toggle('d-none', !e.target.checked);
    
    function editItem(idx) {
        const d = STATE.media[idx]; document.getElementById('formMode').value='EDIT'; document.getElementById('editRowIdx').value=d[13];
        document.getElementById('inJudul').value=d[5]; document.getElementById('inMapel').value=d[6]; document.getElementById('inJenis').value=d[11];
        if(d[7].length>5){ document.getElementById('stHtml').click(); document.getElementById('inHtml').value=d[7]; } else { document.getElementById('stLink').click(); document.getElementById('inLink').value=d[8]; }
        if(d[10]){ document.getElementById('checkKaih').click(); document.getElementById('inKaihType').value=d[10]; }
        showModalInput();
    }
    
    function delItem(id) { Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true}).then(r=>{if(r.isConfirmed) api('hapus',{id}).then(()=>loadData())}); }
    
    function bukaKurasi(id,st,fb) { document.getElementById('kurasiId').value=id; document.getElementById('kurasiStatus').value=st; document.getElementById('kurasiFeedback').value=fb; new bootstrap.Modal('#modalKurasi').show(); }
    function simpanKurasi() { api('updateKurasi', {id:document.getElementById('kurasiId').value, status:document.getElementById('kurasiStatus').value, feedback:document.getElementById('kurasiFeedback').value}).then(()=>{ bootstrap.Modal.getInstance(document.getElementById('modalKurasi')).hide(); loadData(); Swal.fire('Updated','','success'); }); }

    function loginModal() {
        Swal.fire({title:'PIN Guru', input:'password', showCancelButton:true}).then(r=>{
            if(r.value) { Swal.showLoading(); api('login',{pin:r.value}).then(res=>{ if(res.status==='success'){ localStorage.setItem('GB_USER',JSON.stringify(res.user)); STATE.user=res.user; updateUI(); Swal.fire('Sukses','','success'); } else Swal.fire('Gagal',res.message,'error'); }); }
        });
    }
    function logout() { localStorage.removeItem('GB_USER'); STATE.user={name:'Tamu',role:'GUEST'}; updateUI(); loadData(); }
    function loadMoreItems() { STATE.limit += STATE.step; renderGaleri(); }
    
    // Users Stub
    function loadUserList() { api('users').then(res=>{ document.getElementById('statUsers').innerText=res.data.length; document.getElementById('tableUsers').innerHTML = res.data.map(u=>`<tr><td>${u[0]}</td><td><span class="badge bg-light text-dark border">${u[3]}</span></td></tr>`).join(''); }); }
    function showModalUser() { new bootstrap.Modal('#modalUser').show(); }
    function prosesSimpanUser() { api('simpanUser', {nama:document.getElementById('userName').value, sekolah:document.getElementById('userSchool').value, pin:document.getElementById('userPin').value, role:document.getElementById('userRole').value}).then(()=>{ bootstrap.Modal.getInstance(document.getElementById('modalUser')).hide(); loadUserList(); Swal.fire('Tersimpan','','success'); }); }

  </script>
</body>
</html>
