<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Guru Berbagi - Selogiri</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
    
    :root { 
      --primary: #0f766e; /* Teal Elegan */
      --primary-dark: #0d9488;
      --bg-body: #f8fafc; 
      --text-main: #1e293b;
    }

    body { background-color: var(--bg-body); font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text-main); padding-bottom: 60px; }

    /* --- HERO SECTION --- */
    .hero-section {
      background: linear-gradient(135deg, #0f766e 0%, #115e59 100%);
      padding: 50px 0 80px;
      color: white;
      border-radius: 0 0 30px 30px;
      margin-bottom: -40px;
      box-shadow: 0 4px 20px rgba(15, 118, 110, 0.2);
    }
    .hero-search {
      background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50px; padding: 5px 20px; backdrop-filter: blur(5px);
    }
    .hero-search input { background: transparent; border: none; color: white; font-weight: 600; }
    .hero-search input::placeholder { color: rgba(255,255,255,0.7); }
    .hero-search input:focus { outline: none; }

    /* --- NAVBAR --- */
    .navbar { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; }

    /* --- CARD KARYA --- */
    .card-karya { border: none; border-radius: 16px; overflow: hidden; background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.3s; height: 100%; display: flex; flex-direction: column; }
    .card-karya:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    
    .card-thumb { height: 150px; background: #e2e8f0; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
    
    .badge-type { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); color: #333; font-size: 0.65rem; padding: 3px 8px; border-radius: 6px; font-weight: 800; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .badge-status { position: absolute; bottom: 10px; right: 10px; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; background: white; }
    .btn-fav { position: absolute; top: 10px; right: 10px; border: none; background: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; color: #94a3b8; transition: 0.2s; }
    .btn-fav:hover, .btn-fav.active { color: #ef4444; transform: scale(1.1); }

    .card-body-custom { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
    .meta-tags { display: flex; gap: 5px; margin-bottom: 8px; }
    .tag { font-size: 0.6rem; padding: 2px 8px; border-radius: 4px; font-weight: 700; background: #f1f5f9; color: #64748b; text-transform: uppercase; }
    .karya-title { font-weight: 800; font-size: 0.95rem; line-height: 1.4; margin-bottom: 4px; color: #0f172a; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.8em; }
    .guru-info { display: flex; align-items: center; gap: 8px; margin-top: auto; padding-top: 12px; border-top: 1px dashed #e2e8f0; }
    .guru-avatar { width: 30px; height: 30px; background: #cbd5e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 0.8rem; }

    .btn-action { width: 100%; border: none; background: var(--primary); color: white; padding: 8px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; margin-top: 10px; transition: 0.2s; }
    .btn-action:hover { background: var(--primary-dark); }
    .action-group { display: flex; gap: 5px; margin-top: 10px; }
    .btn-icon { flex: 1; border: 1px solid #e2e8f0; background: white; color: #64748b; padding: 6px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
    .btn-icon:hover { background: #f8fafc; color: #333; }

    /* UTILS */
    .d-none { display: none !important; }
    .fab-add { position: fixed; bottom: 30px; right: 30px; width: 55px; height: 55px; border-radius: 50%; background: #1e293b; color: white; border: none; font-size: 1.4rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; z-index: 1020; transition: 0.3s; }
    .fab-add:hover { transform: scale(1.1) rotate(90deg); background: var(--primary); }

    /* PREVIEW OVERLAY */
    #previewOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 20000; display: none; flex-direction: column; }
    .overlay-head { background: #111; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; }
    #previewFrame { width: 100%; flex-grow: 1; border: none; background: white; }
  </style>
</head>
<body>

  <div id="previewOverlay">
    <div class="overlay-head">
      <div id="prevTitle" class="fw-bold text-truncate" style="max-width: 70%;">Preview</div>
      <button class="btn btn-sm btn-danger rounded-pill fw-bold px-3" onclick="tutupPreview()">TUTUP</button>
    </div>
    <iframe id="previewFrame"></iframe>
  </div>

  <nav class="navbar py-2">
    <div class="container d-flex justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <img src="https://i.imgur.com/4PToETN.png" alt="Logo" height="42">
        <div style="line-height:1.1">
          <div class="fw-bold" style="color:var(--primary); font-size:1.1rem;">GURU BERBAGI</div>
          <div class="small text-muted" style="font-size:0.65rem;">KORWILCAMBIDIK SELOGIRI</div>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button id="btnHome" class="btn btn-outline-secondary btn-sm rounded-pill fw-bold d-none" onclick="switchView('GALERI')">Kembali</button>
        <button id="btnAdmin" class="btn btn-warning btn-sm rounded-pill fw-bold d-none text-dark" onclick="switchView('ADMIN')">Admin</button>
        <button id="btnLogin" class="btn btn-primary btn-sm rounded-pill fw-bold px-3" onclick="loginModal()">Login</button>
        <div id="userPanel" class="d-none d-flex align-items-center gap-2">
           <span id="uName" class="fw-bold small text-dark">User</span>
           <button onclick="logout()" class="btn btn-light btn-sm border text-danger"><i class="fas fa-power-off"></i></button>
        </div>
      </div>
    </div>
  </nav>

  <div class="hero-section text-center" id="heroSection">
     <div class="container px-4">
        <h3 class="fw-bold mb-3">Referensi Mengajar Terbaik</h3>
        <div class="hero-search d-inline-flex align-items-center bg-white bg-opacity-25 rounded-pill px-3 py-2 w-100" style="max-width:500px;">
           <i class="fas fa-search text-white opacity-75"></i>
           <input type="text" id="searchInput" class="form-control border-0 bg-transparent text-white fw-bold shadow-none" placeholder="Cari materi..." oninput="doSearch()">
        </div>
     </div>
  </div>

  <div id="view-galeri" class="container mt-5 fade-in">
    <div class="d-flex gap-2 mb-4 overflow-auto pb-2">
       <select id="fMapel" class="form-select form-select-sm rounded-pill fw-bold text-secondary" style="min-width:140px" onchange="doSearch()"><option value="">ðŸ“š Mapel</option></select>
       <select id="fFase" class="form-select form-select-sm rounded-pill fw-bold text-secondary" style="min-width:120px" onchange="doSearch()"><option value="">ðŸŽ“ Fase</option></select>
       <button onclick="filterMode='ALL'; doSearch()" class="btn btn-sm btn-dark rounded-pill fw-bold px-3">Semua</button>
       <button id="btnMy" onclick="filterMode='MY'; doSearch()" class="btn btn-sm btn-outline-primary rounded-pill fw-bold px-3 d-none">Saya</button>
       <button onclick="filterMode='FAV'; doSearch()" class="btn btn-sm btn-outline-danger rounded-pill px-3"><i class="fas fa-heart"></i></button>
    </div>

    <div id="loading" class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    <div id="galeri-container" class="row gx-3 gx-md-4 gy-4"></div>
    
    <div id="loadMore" class="text-center mt-5 d-none">
       <button onclick="loadMore()" class="btn btn-outline-primary rounded-pill px-4 fw-bold">Muat Lebih Banyak</button>
    </div>
  </div>

  <div id="view-admin" class="container mt-4 d-none">
     <div class="card p-4 border-0 shadow-sm mb-4">
        <h5 class="fw-bold mb-0">Dashboard Admin</h5>
        <small class="text-muted">Kelola data dan pengguna</small>
     </div>
     <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-karya">Karya</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-users" onclick="loadUserList()">Guru</button></li>
     </ul>
     <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-karya">
           <div class="d-flex gap-2 mb-3">
              <input type="text" class="form-control rounded-pill" placeholder="Cari judul/guru..." oninput="renderAdminTable(this.value)">
              <select id="fAdmStatus" class="form-select rounded-pill" style="width:150px" onchange="renderAdminTable()">
                 <option value="">Semua</option><option value="BARU">Baru</option><option value="DISETUJUI">Setuju</option>
              </select>
           </div>
           <div class="table-responsive border rounded bg-white"><table class="table table-hover mb-0 align-middle"><thead><tr><th class="ps-3">Judul</th><th>Guru</th><th>Status</th><th class="text-end pe-3">Aksi</th></tr></thead><tbody id="admTable"></tbody></table></div>
        </div>
        <div class="tab-pane fade" id="tab-users">
           <button class="btn btn-primary btn-sm mb-3 rounded-pill px-3" onclick="resetUser(); modal('modalUser').show()">+ Guru</button>
           <div class="table-responsive border rounded bg-white"><table class="table table-hover mb-0 align-middle"><thead><tr><th class="ps-3">Nama</th><th>Sekolah</th><th>PIN</th><th class="text-end pe-3">Hapus</th></tr></thead><tbody id="userTable"></tbody></table></div>
        </div>
     </div>
  </div>

  <button id="btnAdd" class="fab-add d-none" onclick="resetForm(); modal('modalInput').show()"><i class="fas fa-plus"></i></button>

  <div class="modal fade" id="modalInput" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content border-0 shadow"><div class="modal-header border-bottom-0"><h5 class="fw-bold">Input Karya</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formInput"><input type="hidden" id="formMode" value="ADD"><input type="hidden" id="editId"><div class="mb-3"><label class="small fw-bold">Judul</label><input type="text" id="inJudul" class="form-control" required></div><div class="row g-2 mb-3"><div class="col-6"><label class="small fw-bold">Mapel</label><select id="inMapel" class="form-select"></select></div><div class="col-6"><label class="small fw-bold">Jenis</label><select id="inJenis" class="form-select"></select></div></div><div class="row g-2 mb-3"><div class="col-6"><label class="small fw-bold">Fase</label><select id="inFase" class="form-select"></select></div><div class="col-6"><label class="small fw-bold">Semester</label><select id="inSem" class="form-select"></select></div></div><div class="bg-light p-2 rounded mb-3 d-flex align-items-center justify-content-between"><div><label class="small fw-bold">Program KAIH?</label></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkKaih" onchange="document.getElementById('inKaih').classList.toggle('d-none',!this.checked)"></div></div><select id="inKaih" class="form-select mb-3 d-none"></select><div class="mb-3"><label class="small fw-bold">Tipe Konten</label><select id="inputType" class="form-select" onchange="toggleType(this.value)"><option value="LINK">ðŸ”— Link (YouTube/Drive/Gemini)</option><option value="HTML">ðŸ’» Embed HTML</option></select></div><div id="boxLink"><input type="url" id="inLink" class="form-control" placeholder="https://..."></div><div id="boxHtml" class="d-none"><textarea id="inHtml" class="form-control font-monospace small" rows="3" placeholder="<iframe..."></textarea></div></form></div><div class="modal-footer border-top-0"><button onclick="saveData()" class="btn btn-primary w-100 rounded-pill">SIMPAN</button></div></div></div></div>
  <div class="modal fade" id="modalKurasi" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 shadow"><div class="modal-header"><h5 class="fw-bold">Kurasi</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="kurId"><select id="kurStat" class="form-select mb-3"><option value="BARU">BARU</option><option value="DISETUJUI">DISETUJUI</option><option value="REVISI">REVISI</option></select><textarea id="kurNote" class="form-control" rows="3" placeholder="Catatan..."></textarea></div><div class="modal-footer"><button onclick="saveKurasi()" class="btn btn-success w-100 rounded-pill">UPDATE</button></div></div></div></div>
  <div class="modal fade" id="modalUser" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 shadow"><div class="modal-header"><h5 class="fw-bold">Guru</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="uN" class="form-control mb-2" placeholder="Nama"><input id="uS" class="form-control mb-2" placeholder="Sekolah"><input id="uP" class="form-control mb-2" placeholder="PIN"><select id="uR" class="form-select"><option value="GURU">GURU</option><option value="ADMIN">ADMIN</option></select></div><div class="modal-footer"><button onclick="saveUser()" class="btn btn-primary w-100 rounded-pill">SIMPAN</button></div></div></div></div>

  <script>
    // --- SETTING API ---
    const API_URL = "https://script.google.com/macros/s/AKfycbzhrWjl2Dc0i8V45dD8vNXrt3gfmvEU1pZ5hZOELkTz6e29l68d2hsHfGQEjqTVYdY0/exec";

    // STATE
    var STATE = { media:[], users:[], settings:[], user:{name:'Tamu',role:'GUEST'}, filter:'ALL', limit:12, page:1 };
    var ACTIVE = null;

    // --- API CALLER (FETCH) ---
    async function api(act, pl=null) {
       try {
         var opt = { method:'POST', body:JSON.stringify({action:act, payload:pl}) };
         var u = act==='read' ? API_URL+'?action=read' : API_URL;
         var r = await fetch(u, act==='read'?undefined:opt);
         return await r.json();
       } catch(e){ return {status:'error', message:e.toString()}; }
    }

    // --- INIT ---
    window.onload = () => {
       var u = localStorage.getItem('GB_USER'); if(u) STATE.user = JSON.parse(u);
       updateUI(); fetchData();
    };

    function fetchData() {
       api('read').then(res => {
          if(res.status==='success') {
             STATE.media = res.media; STATE.settings = res.settings;
             fillOpts(); doSearch();
          }
          document.getElementById('loading').style.display='none';
       });
    }

    // --- UI LOGIC ---
    function updateUI() {
       document.getElementById('uName').innerText = STATE.user.name;
       var isG = STATE.user.role === 'GUEST';
       document.getElementById('btnLogin').classList.toggle('d-none', !isG);
       document.getElementById('userPanel').classList.toggle('d-none', isG);
       document.getElementById('btnAdmin').classList.toggle('d-none', STATE.user.role!=='ADMIN');
       document.getElementById('btnAdd').classList.toggle('d-none', isG);
       document.getElementById('btnMy').classList.toggle('d-none', isG);
    }
    
    function switchView(v) {
       document.getElementById('view-galeri').classList.toggle('d-none', v!=='GALERI');
       document.getElementById('view-admin').classList.toggle('d-none', v!=='ADMIN');
       document.getElementById('heroSection').classList.toggle('d-none', v!=='GALERI');
       document.getElementById('btnHome').classList.toggle('d-none', v==='GALERI');
       if(v==='ADMIN') { renderAdminTable(); loadUserList(); }
    }

    // --- GALLERY ---
    function doSearch() {
       var q = document.getElementById('searchInput').value.toLowerCase();
       var fM = document.getElementById('fMapel').value;
       var fF = document.getElementById('fFase').value;
       var favs = JSON.parse(localStorage.getItem('GB_FAV')||'[]');

       var res = STATE.media.filter(d => {
          var str = (d[1]+d[5]+d[6]).toLowerCase();
          var matchQ = str.includes(q);
          var matchM = fM ? d[6]===fM : true;
          var matchF = fF ? d[3]===fF : true;
          var matchMod = true;
          if(STATE.filter==='MY') matchMod = d[1]===STATE.user.name;
          if(STATE.filter==='FAV') matchMod = favs.includes(d[13]);
          var isPub = d[9]==='DISETUJUI' || d[1]===STATE.user.name || STATE.user.role==='ADMIN';
          return matchQ && matchM && matchF && matchMod && isPub;
       });

       renderCards(res.slice(0, STATE.limit * STATE.page));
       document.getElementById('loadMore').classList.toggle('d-none', res.length <= STATE.limit * STATE.page);
    }
    
    function loadMore() { STATE.page++; doSearch(); }

    function renderCards(list) {
       var c = document.getElementById('galeri-container'); c.innerHTML='';
       var favs = JSON.parse(localStorage.getItem('GB_FAV')||'[]');
       
       list.forEach(d => {
          var idx = STATE.media.indexOf(d); // REAL INDEX
          var isFav = favs.includes(d[13]);
          var heart = isFav ? 'fas text-danger' : 'far text-secondary';
          var badge = d[9]!=='DISETUJUI' ? '<span class="badge-status bg-warning text-dark border">PENDING</span>' : '';
          
          // SMART QR
          var lnk = d[8]||""; 
          if(!lnk && d[7]) { var m=d[7].match(/src=["'](.*?)["']/); if(m) lnk=m[1]; }
          if(lnk.includes('gemini.google.com/share')) lnk = lnk.replace('gemini.google.com/share', 'g.co/gemini/share');
          var btnQR = lnk.length>5 ? `<button onclick="showQR('${lnk}')" class="btn-icon"><i class="fas fa-qrcode"></i></button>` : '';
          
          // EDIT BUTTONS
          var btns = (STATE.user.name===d[1] || STATE.user.role==='ADMIN') ? 
             `<button onclick="editItem(${idx})" class="btn-icon"><i class="fas fa-pencil"></i></button>
              <button onclick="delItem(${idx})" class="btn-icon text-danger"><i class="fas fa-trash"></i></button>` : '';

          // THUMBNAIL
          var thumb = getThumb(d);
          var type = d[11] || 'MEDIA';

          c.innerHTML += `
          <div class="col-6 col-md-4 col-lg-3 fade-in">
             <div class="card-karya">
                <div class="card-thumb">
                   ${thumb} ${badge}
                   <span class="badge-type">${type}</span>
                   <button onclick="fav('${d[13]}')" class="btn-fav"><i class="${heart} fa-heart"></i></button>
                </div>
                <div class="card-body-custom">
                   <div class="meta-tags"><span class="tag">${d[6]}</span><span class="tag">${d[3]}</span></div>
                   <div class="karya-title" title="${d[5]}">${d[5]}</div>
                   <div class="guru-info">
                      <div class="guru-avatar">${d[1].charAt(0)}</div>
                      <div class="lh-1">
                         <div class="fw-bold small text-truncate" style="max-width:120px">${d[1]}</div>
                         <div class="text-muted" style="font-size:0.65rem">${d[2]}</div>
                      </div>
                   </div>
                   <div class="mt-auto">
                      <button onclick="openItem(${idx})" class="btn-action">BUKA KARYA</button>
                      <div class="action-group">${btnQR}${btns}</div>
                   </div>
                </div>
             </div>
          </div>`;
       });
    }

    function getThumb(d) {
       var l = d[8]||"", t = (d[11]||"").toUpperCase();
       if(l.includes('youtu')) { var i=l.match(/v=([^&]+)/)||l.match(/youtu\.be\/([^?]+)/); if(i) return `<img src="https://img.youtube.com/vi/${i[1]}/mqdefault.jpg">`; }
       var c='#64748b', i='fa-file';
       if(t.includes('VIDEO')){c='#ef4444';i='fa-play';} 
       else if(t.includes('GAME')){c='#8b5cf6';i='fa-gamepad';} 
       else if(t.includes('MODUL')||t.includes('BUKU')){c='#10b981';i='fa-book';} 
       else if(t.includes('STORY')||t.includes('GEMINI')){c='#f59e0b';i='fa-robot';}
       else if(t.includes('PRESENTASI')||t.includes('PPT')){c='#f97316';i='fa-desktop';}
       return `<div style="background:${c};width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:white"><i class="fas ${i} fa-3x"></i></div>`;
    }

    function openItem(idx) {
       var d=STATE.media[idx], l=d[8], h=d[7];
       api('view',{id:d[13]});
       
       // FIX GEMINI DIRECT OPEN
       if(l && (l.includes('gemini')||l.includes('story')||l.includes('quizizz'))) {
          if(l.includes('/share')) l=l.replace('gemini.google.com/share','g.co/gemini/share');
          window.open(l, '_blank'); return;
       }

       document.getElementById('prevTitle').innerText = d[5];
       var ov=document.getElementById('previewOverlay'), fr=document.getElementById('previewFrame');
       ov.style.display='flex'; fr.src="about:blank";

       if(h && h.length>10) fr.src=URL.createObjectURL(new Blob([h],{type:'text/html'}));
       else if(l) {
          if(l.includes('youtu')) { var i=l.match(/v=([^&]+)/)||l.match(/youtu\.be\/([^?]+)/); fr.src=`https://www.youtube.com/embed/${i[1]}?autoplay=1`; }
          else if(l.includes('drive')) fr.src=l.replace('/view','/preview');
          else fr.src=l;
       }
    }
    
    function showQR(l) { Swal.fire({html:`<img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(l)}" class="img-fluid mb-2"><br><a href="${l}" target="_blank" class="btn btn-sm btn-dark">Buka Link</a>`, showConfirmButton:false, showCloseButton:true}); }
    function fav(id) { var k='GB_FAV',s=JSON.parse(localStorage.getItem(k)||'[]'); if(s.includes(id))s=s.filter(x=>x!==id);else s.push(id); localStorage.setItem(k,JSON.stringify(s)); doSearch(); }
    function tutupPreview() { document.getElementById('previewOverlay').style.display='none'; document.getElementById('previewFrame').src=""; }
    function modal(id) { return new bootstrap.Modal(document.getElementById(id)); }

    // --- CRUD ---
    function saveData() {
       var p = {
          mode:document.getElementById('formMode').value, idUnik:document.getElementById('editId').value,
          nama:STATE.user.name, sekolah:STATE.user.school,
          judul:document.getElementById('inJudul').value, mapel:document.getElementById('inMapel').value, jenis:document.getElementById('inJenis').value,
          fase:document.getElementById('inFase').value, semester:document.getElementById('inSem').value,
          linkLuar:document.getElementById('inLink').value, kodeHtml:document.getElementById('inHtml').value,
          kaihType:document.getElementById('checkKaih').checked?document.getElementById('inKaih').value:''
       };
       if(p.linkLuar.includes('gemini.google.com/share')) p.linkLuar=p.linkLuar.replace('gemini.google.com/share','g.co/gemini/share');

       Swal.fire({title:'Menyimpan...',didOpen:()=>Swal.showLoading()});
       api('simpan',p).then(res=>{
          if(res.status==='success') { Swal.fire('Berhasil','','success'); fetchData(); bootstrap.Modal.getInstance(document.getElementById('modalInput')).hide(); }
          else Swal.fire('Gagal',res.message,'error');
       });
    }
    function delItem(idx) {
       Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true}).then(r=>{
          if(r.isConfirmed) api('hapus',{id:STATE.media[idx][13]}).then(()=>fetchData());
       });
    }
    
    // --- ADMIN ---
    function renderAdminTable(q='') {
       var t=document.getElementById('admTable'); t.innerHTML='';
       var st=document.getElementById('fAdmStatus').value;
       var list = STATE.media.filter(d => (d[1]+d[5]).toLowerCase().includes(q.toLowerCase()) && (st===''||d[9]===st));
       list.forEach(d => {
          var idx = STATE.media.indexOf(d);
          var bg = d[9]==='DISETUJUI'?'bg-success':(d[9]==='REVISI'?'bg-danger':'bg-warning text-dark');
          t.innerHTML += `<tr><td class="ps-3"><div class="fw-bold">${d[5]}</div><div class="small text-muted">${d[6]}</div></td><td><div class="fw-bold">${d[1]}</div><small>${d[2]}</small></td><td><span class="badge ${bg}">${d[9]}</span></td><td class="text-end pe-3"><button onclick="editKurasi(${idx})" class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-check"></i></button><button onclick="delItem(${idx})" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`;
       });
    }
    function editKurasi(idx) { var d=STATE.media[idx]; document.getElementById('kurId').value=d[13]; document.getElementById('kurStat').value=d[9]; document.getElementById('kurNote').value=d[12]; modal('modalKurasi').show(); }
    function saveKurasi() { api('updateKurasi',{id:document.getElementById('kurId').value, status:document.getElementById('kurStat').value, feedback:document.getElementById('kurNote').value}).then(()=>{ fetchData(); bootstrap.Modal.getInstance(document.getElementById('modalKurasi')).hide(); }); }
    
    function loadUserList() {
       api('users').then(res=>{
          var t=document.getElementById('userTable'); t.innerHTML='';
          res.data.forEach(u => t.innerHTML+=`<tr><td class="ps-3 fw-bold">${u[0]}</td><td>${u[1]}</td><td>${u[2]}</td><td class="text-end pe-3"><button onclick="delUser('${u[2]}')" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button></td></tr>`);
       });
    }
    function saveUser() {
       api('simpanUser',{nama:document.getElementById('uN').value, sekolah:document.getElementById('uS').value, pin:document.getElementById('uP').value, role:document.getElementById('uR').value}).then(res=>{
           if(res.status==='success') { loadUserList(); bootstrap.Modal.getInstance(document.getElementById('modalUser')).hide(); Swal.fire('Sukses'); }
           else Swal.fire('Gagal',res.message,'error');
       });
    }
    function delUser(p) { if(confirm('Hapus?')) api('hapusUser',{pin:p}).then(()=>loadUserList()); }

    // --- AUTH & HELPERS ---
    function loginModal() { Swal.fire({title:'PIN',input:'password'}).then(r=>{ if(r.value) api('login',{pin:r.value}).then(res=>{ if(res.status==='success'){ localStorage.setItem('GB_USER',JSON.stringify(res.user)); location.reload(); } else Swal.fire('Salah'); }); }); }
    function logout() { localStorage.removeItem('GB_USER'); location.reload(); }
    function fillOpts() {
       var f=(id,i,def)=>{ var e=document.getElementById(id); e.innerHTML=`<option value="">${def}</option>`; [...new Set(STATE.settings.map(s=>s[i]).filter(Boolean))].forEach(v=>e.innerHTML+=`<option value="${v}">${v}</option>`); };
       f('fMapel',1,'ðŸ“š Mapel'); f('fFase',2,'ðŸŽ“ Fase');
       f('inMapel',1,'Pilih'); f('inJenis',0,'Pilih'); f('inFase',2,'Pilih'); f('inSem',4,'Pilih'); f('inKaih',3,'Pilih');
    }
    function toggleType(v) { document.getElementById('boxLink').classList.toggle('d-none',v!=='LINK'); document.getElementById('boxHtml').classList.toggle('d-none',v!=='HTML'); }
    function resetForm() { document.getElementById('formInput').reset(); document.getElementById('formMode').value='ADD'; toggleType('LINK'); }
    function resetUser() { document.getElementById('formUser').reset(); }
    function editItem(idx) {
       var d=STATE.media[idx]; document.getElementById('formMode').value='EDIT'; document.getElementById('editId').value=d[13];
       document.getElementById('inJudul').value=d[5]; document.getElementById('inHtml').value=d[7]; document.getElementById('inLink').value=d[8];
       document.getElementById('inMapel').value=d[6]; document.getElementById('inJenis').value=d[11];
       modal('modalInput').show();
    }
  </script>
</body>
</html>
